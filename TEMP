# Copyright (C) 1994-2023 Synopsys Inc.
# swbtree vV-2023.12, saved by gsub0

# --- simulation flow
sprocess sprocess "" {}
IdVg sdevice "" {}
IdVg Vd "1.0" {5.0} R
PlotIdVg svisual "" {}
CV sdevice "" {}
PlotCV svisual "" {}
# --- variables
# --- scenarios and parameter specs
scenario default Vd ""
# --- simulation tree
0 2 0 {} {default} 0
1 7 2 {} {default} 0
2 22 7 {5.0} {default} 0
3 24 22 {} {default} 0
4 25 24 {} {default} 0
5 27 25 {} {default} 0


#----------------------------------------------------------------------------------

math coord.ucs

AdvancedCalibration

pdbSet ImplantData LeftBoundary  Reflect
pdbSet ImplantData RightBoundary Reflect
                     
pdbSet ImplantData DoseControl BeamDose
pdbSet Oxide_Silicon Boundary BoundaryCondition ThreePhaseSegregation
                                            

fset Fastmode 0
if { $Fastmode == 1} {
    pdbSet ImplantData NoImplant 1
    pdbSet Diffuse NoDiffusionReaction 1
}

#header

fset Sox   0.01
fset Tsi   0.22
fset Tbox  2.0
fset Tsub  5.0
fset Tsietch 0.15
fset Xmin 0.0
fset Xmax [expr ($Tsi+$Tbox+$Tsub)]

fset Ymin 0.0
fset Ymax 4.0
fset Lsietch 1.275
fset Lmd  0.5
fset LPNpp [expr ($Ymax-$Lsietch*2-$Lmd)*0.5]

fset LPp2P 0.525
fset LPpPR [expr ($Ymax*0.5-$LPp2P)]
fset LNpPR [expr ($Ymax*0.5+$LPp2P)]

fset Lct 0.175
#endheader

# uncomment following line, if you have 4 CPU or more.
math numThreads= 8


line x location= $Xmin   tag= top
line x location= 10.0    tag= bottom

line y location= $Ymin tag= left
line y location= $Ymax tag= right


#------ Simulation Region Define -------------------
region Silicon substrate xlo= top xhi= bottom ylo= left yhi= right
init concentration= 1e15 field= Boron wafer.orient= 100 flat.orient= {1 1 0}

##-----Initial mesh setting-----------

grid set.min.normal.size= 0.005 \
     set.normal.growth.ratio.2d= 2.0 \
     set.max.points= 10000000 set.max.neighbor.ratio= 1e6

refinebox name=Global_Si Silicon       \
    min= "$Xmin $Ymin" max= "$Xmax $Ymax"  \
    xrefine= "0.05 1.0 "                   \
    yrefine= "0.2 0.2"               

refinebox name=Global_Top Silicon       \
    min= "$Xmin $Ymin" max= "$Tsi*1.5 $Ymax"  \
    xrefine= "0.005 0.01 "                   \
    yrefine= "0.05  0.05"                 

refinebox name=Global_JUNC Silicon       \
    min= "$Xmin $Ymax*0.5-0.2" max= "$Tsi*1.5 $Ymax*0.5+0.2"  \
    xrefine= "0.005 0.01 "                   \
    yrefine= "0.01  0.01"        
    
grid remesh

etch silicon type= cmp coord= $Tsi+$Tbox 

deposit material= {Oxide}   type= fill  coord= {$Tsi}
deposit material= {Silicon} type= fill  coord= 0.0 region.name= SOI fields.values= {Boron=1e15}

mask name= Tetch segments= { $Ymin $LPNpp $LPNpp+$Lsietch $LPNpp+$Lsietch+$Lmd $LPNpp+$Lsietch*2+$Lmd $Ymax } negative
photo mask= Tetch thickness= 1.0
etch material= {Silicon} type= anisotropic thickness= $Tsietch
strip photoresist

deposit material= {Oxide}   type= fill  coord= -0.01

mask name= Ptype left= $Xmin right= $Ymax*0.5 
photo mask= Ptype thickness= 1.0
implant Boron dose= 1.0e13 energy= 30.0 tilt= 0.0
implant Boron dose= 1.0e13 energy= 48.0 tilt= 0.0
strip photoresist

mask name= Ntype left= $Xmin right= $Ymax*0.5 negative
photo mask= Ntype thickness= 1.0
implant Phosphorus dose= 1.0e13 energy= 80.0  tilt= 0.0
implant Phosphorus dose= 1.0e13 energy= 140.0 tilt= 0.0
strip photoresist

mask name= Pptype left= $Xmin right= $LPpPR 
photo mask= Pptype thickness= 1.0
implant Boron dose= 1.5e14 energy= 48.0 tilt= 0.0
strip photoresist

mask name= Nptype left= $Xmin right= $LNpPR negative
photo mask= Nptype thickness= 1.0
implant Phosphorus dose= 1.5e14 energy= 140.0 tilt= 0.0
strip photoresist

mask name= Ppptype left= $Xmin right= $LPNpp 
photo mask= Pptype thickness= 1.0
implant Boron dose= 3.0e15 energy= 10.0 tilt= 0.0
strip photoresist

mask name= Npptype left= $Xmin right= $Ymax-$LPNpp negative
photo mask= Nptype thickness= 1.0
implant Phosphorus dose= 3.0e15 energy= 30.0 tilt= 0.0
strip photoresist
#diffuse temperature= 1050 time= 1<s>

temp_ramp name= ANNL time= 15<s> temp= 750.0  ramprate= 20
temp_ramp name= ANNL time= 12<s> temp= 1050.0 
temp_ramp name= ANNL time= 20<s> temp= 1050.0 ramprate= -15.0
diffuse temp_ramp= ANNL

deposit material= {Oxide}   type= fill  coord= -1.0

mask name= CTmask segments= { $Ymin $Ymin+0.15 $Ymin+0.15+$Lct $Ymax-0.15-$Lct $Ymax-0.15 $Ymax} negative
photo mask= CTmask thickness= 1.0
etch material= {Oxide} type= anisotropic thickness= 1.0*1.1
strip photoresist

deposit material= {Tungsten}   type= fill  coord= -1.0

contact name= "Cpp"  point  x= -0.5 y= $Ymin+0.15+$Lct*0.5 Tungsten replace
contact name= "Cnp"  point  x= -0.5 y= $Ymax-0.15-$Lct*0.5 Tungsten replace
	
struct tdr= n@node@ !Gas

exit

#----------------------------------------------------------------------------------

#setdep @node|sprocess@

File {
  Grid      = "@tdr@"  
  Parameter = "@parameter@"
  Plot      = "@tdrdat@"
  Current   = "@plot@"
  Output    = "@log@"
  
}

Electrode {
  { Name="Cpp"    Voltage=0.0 }
  { Name="Cnp"     Voltage=0.0 }

}

Physics {Fermi}

Physics (Material= Silicon) {	
	Mobility (
    HighFieldSaturation
    DopingDependence
	)
    Recombination(SRH)
    EffectiveIntrinsicDensity(OldSlotboom)
    Recombination( SRH( DopingDep ) Band2Band(Model= Hurkx) Avalanche(Okuto) )      
}

Plot{
  eDensity hDensity
  TotalCurrent/Vector eCurrent/Vector hCurrent/Vector
  eMobility hMobility
  eVelocity hVelocity
  eQuasiFermi hQuasiFermi
  eTemperature Temperature * hTemperature
  ElectricField/Vector Potential SpaceCharge
  Doping DonorConcentration AcceptorConcentration
  SRH Band2Band * Auger
  AvalancheGeneration eAvalancheGeneration hAvalancheGeneration
  eGradQuasiFermi/Vector hGradQuasiFermi/Vector
  eEparallel hEparallel eENormal hENormal
  BandGap 
  BandGapNarrowing
  Affinity
  ConductionBand ValenceBand
  eBarrierTunneling hBarrierTunneling * BarrierTunneling
  eTrappedCharge  hTrappedCharge
  eGapStatesRecombination hGapStatesRecombination
  eDirectTunnel hDirectTunnel
  
}

Math {
  Extrapolate
  Derivatives
  RelErrControl
  Digits=5
  RHSmin=1e-10
  Notdamped=100
  Iterations=50
  DirectCurrent
  ExitOnFailure
  
  * Please uncomment if you have 8 CPUs or more
  **NumberOfThreads= 8
  
}

Solve {
  Coupled { Poisson }
  Coupled ( Iterations= 100 LineSearchDamping= 1e-8 ){ Poisson } 
  Coupled { Poisson Electron Hole }
  
  NewCurrentPrefix= "IV_" 
  Quasistationary( 
    InitialStep= 1e-2 Increment= 1.3 
    MinStep= 1e-6 MaxStep= 0.05 
    Goal { Name="Cpp" Voltage= @Vd@ } 
  ){ Coupled { Poisson Electron Hole } }
}

#----------------------------------------------------------------------------------

#----------------------------------------------------------------------#
load_library extract
lib::SetInfoDef 1
#----------------------------------------------------------------------#
set N     @node@
set i     @node:index@

set Weff  1.0
set Vd1 4
set Vd2 5

#- Automatic alternating color assignment tied to node index
#----------------------------------------------------------------------#
set COLORS  [list green blue red orange magenta violet brown]
set NCOLORS [llength $COLORS]
set color   [lindex  $COLORS [expr $i%$NCOLORS]]

#- Plotting IdVg
#----------------------------------------------------------------------#
echo "#########################################"
echo "Plotting IV curve"
echo "#########################################"
load_file @[relpath IV_@plot@]@ -name PLT_IV($N)

if {[lsearch [list_plots] Plot_IdVg] == -1} {
	create_plot -1d -name Plot_IdVg
}
select_plots Plot_IdVg

set Vp [get_variable_data "Cpp OuterVoltage" -dataset PLT_IV($N)]
set Ip [get_variable_data "Cpp TotalCurrent" -dataset PLT_IV($N)]

create_curve -name IdVgIV($N) -dataset PLT_IV($N) \
	-axisX "Cpp OuterVoltage" -axisY "Cpp TotalCurrent"
	
	
set_curve_prop IdVgIV($N) -label "IV" \
	-color $color -line_style solid -line_width 3 \
	-markers_type circle -markers_size 5 -show_markers

ext::ExtractValue -out Id1 -name "noprint" -x $Vp -y $Ip -yLog 1 -xo $Vd1
ext::ExtractValue -out Id2 -name "noprint" -x $Vp -y $Ip -yLog 1 -xo $Vd2

set Ron [expr (($Vd2-$Vd1)/($Id2-$Id1))]
puts "DOE: Ron [format %.3f $Ron]"

#----------------------------------------------------------------------------------


#setdep @node|sprocess@

Device CV {

Electrode {
	{ Name="Cpp"    Voltage=0.0 }
	{ Name="Cnp"    Voltage=0.0 }
          }

File {
   * input files:
   Grid=    "@tdr@" 
   Parameter= "@parameter@"
   * output files:
   Plot=    "@tdrdat@"
   Current= "@plot@"
}

Physics{
   Fermi     
}

Physics (Material= Silicon) {
	Mobility (
    HighFieldSaturation
    DopingDependence
	)
    Recombination(SRH)
    EffectiveIntrinsicDensity(OldSlotboom)
    Recombination( SRH( DopingDep ) Band2Band(Model= Hurkx) Avalanche(Okuto) )  
}

}
* End of Device

File {
        ACExtract= "@acplot@"
        output=   "@log@" 
     }

Plot{
  eDensity hDensity
  TotalCurrent/Vector eCurrent/Vector hCurrent/Vector
  eMobility hMobility
  eVelocity hVelocity
  eQuasiFermi hQuasiFermi
  eTemperature hTemperature Temperature 
  ElectricField/Vector Potential SpaceCharge
  Doping DonorConcentration AcceptorConcentration
  SRH Band2Band 
  AvalancheGeneration eAvalancheGeneration hAvalancheGeneration
  eGradQuasiFermi/Vector hGradQuasiFermi/Vector
  eEparallel hEparallel eENormal hENormal
  BandGap 
  BandGapNarrowing
  Affinity
  ConductionBand ValenceBand
  eBarrierTunneling hBarrierTunneling * BarrierTunneling
  eTrappedCharge  hTrappedCharge
  eGapStatesRecombination hGapStatesRecombination
  eDirectTunnel hDirectTunnel
   
}
Math {
  Extrapolate
  Derivatives
  RelErrControl
  Digits= 5  
  Notdamped= 100
  Iterations= 25
  ExitOnFailure 
  RelTermMinDensity= 2e8
  DrForceRefDens= 1e12
                                   
  * Please uncomment if you have 8 CPUs or more
  **Number_of_Threads= 8
}

System {
    CV cv(Cpp=1 Cnp=2 )
    Vsource_pset  vp(1 0) { dc= 0}
    Vsource_pset  vn(2 0) { dc= 0}
     }

Solve {
#- Creating initial guess:                            
   Coupled(Iterations= 1000 LineSearchDamping= 1e-8){ Poisson } 
   Coupled{ Poisson Electron Hole } 
                                     
##   Quasistationary( 
##      InitialStep= 1e-2 Increment= 1.5 
##      MinStep= 1e-5 MaxStep= 0.1 
##      Goal { Parameter= vp.dc Voltage= 0 } 
##   ){ Coupled { Poisson Electron Hole } }

   NewCurrentPrefix="" 
   Quasistationary( 
      DoZero 
      InitialStep= 1e-2 Increment= 1.5 
      MinStep= 1e-5 MaxStep= 0.01
      Goal { Parameter= vp.dc Voltage= 0.01 } 
   ){ ACCoupled (           
       StartFrequency= 1e6 EndFrequency= 1e6 NumberOfPoints= 1 Decade 
       Node(1 2) Exclude(vp vn) 
       ACCompute (Time= (Range = (0 1)  Intervals= 50)) 
      ){ Poisson Electron Hole } 
   }
}
##---------------------------------------------------------------------------------


#----------------------------------------------------------------------#
load_library extract
lib::SetInfoDef 1
#----------------------------------------------------------------------#
set N     @node@
set i     @node:index@

#- Automatic alternating color assignment tied to node index
#----------------------------------------------------------------------#
set COLORS  [list green blue red orange magenta violet brown]
set NCOLORS [llength $COLORS]
set color   [lindex  $COLORS [expr $i%$NCOLORS]]
#----------------------------------------------------------------------#

echo "##############################"
echo "plotting C-V curves"
echo "##############################"
load_file @acplot@ -name AC($N)

if {[lsearch [list_plots] Plot_CV] == -1} {
	create_plot -1d -name Plot_CV
}
select_plots Plot_CV

create_curve -name Cpp($N) -dataset AC($N) -axisX "v(1)" -axisY "c(1,1)"

set_curve_prop Cpp($N) -label "Cpp" \
	-color $color -line_style solid -line_width 3

set_plot_prop -title "C-V Curves" -title_font_size 16 -show_legend
set_axis_prop -axis x -title {Voltage [V]} \
	-title_font_size 16 -label_font_size 14 
set_axis_prop -axis y -title {Capacitance [F]} \
	-title_font_size 16 -label_font_size 14 
set_legend_prop -label_font_size 12 -location bottom_left -label_font_att bold

set Vp  [get_curve_data Cpp($N) -plot Plot_CV -axisX]
set Cpp [get_curve_data Cpp($N) -plot Plot_CV -axisY]

ext::ExtractValue -out Cj -name "Cj" -x $Vp -y $Cpp -xo 0.0


